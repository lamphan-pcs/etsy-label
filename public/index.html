<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Etsy Label Merger</title>
        <style>
            body {
                font-family: sans-serif;
                max-width: 1400px;
                margin: 2rem auto;
                padding: 0 1rem;
                background-color: #f4f4f9;
                color: #333;
            }
            .container {
                background: white;
                padding: 2rem;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            h1 {
                margin-top: 0;
                color: #f0541e;
            }
            .drop-zones {
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
            }
            .drop-zone {
                flex: 1;
                border: 2px dashed #ccc;
                padding: 2rem;
                text-align: center;
                border-radius: 4px;
                cursor: pointer;
                transition: border-color 0.3s;
                min-width: 250px;
            }
            .drop-zone:hover,
            .drop-zone.dragover {
                border-color: #f0541e;
                background-color: #fff5f2;
            }
            .file-info {
                margin-top: 0.5rem;
                font-weight: bold;
                font-size: 0.9rem;
                color: #666;
            }
            .btn {
                background-color: #f0541e;
                color: white;
                border: none;
                padding: 1rem 2rem;
                font-size: 1rem;
                border-radius: 4px;
                cursor: pointer;
                width: 100%;
                transition: background 0.3s;
            }
            .btn:hover {
                background-color: #d1400e;
            }
            .btn:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
            input[type="file"] {
                display: none;
            }

            /* Spinner */
            .spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
                margin-right: 10px;
                vertical-align: middle;
                display: none;
            }
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
            .loading .spinner {
                display: inline-block;
            }
            .result-container {
                margin-top: 2rem;
                overflow-x: auto;
            }
            .data-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1rem;
                font-size: 0.9rem;
            }
            .data-table th,
            .data-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            .data-table th {
                background-color: #f2f2f2;
                color: #333;
            }
            .data-table tbody tr:hover {
                background-color: #e3f2fd;
                cursor: pointer;
            }
            .row-checkbox,
            #autoSelectAllCheck,
            #manualSelectAllCheck,
            #bulkSelectAllCheck {
                transform: scale(1.5);
                cursor: pointer;
            }
            .copy-btn {
                background-color: #2e7d32;
                color: white;
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 4px;
                cursor: pointer;
                float: right;
                margin-left: 0.5rem;
                margin-bottom: 0.5rem;
            }
            .copy-btn:hover {
                background-color: #1b5e20;
            }
            .download-btn {
                background-color: #1976d2;
                color: white;
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 4px;
                cursor: pointer;
                float: right;
                margin-bottom: 0.5rem;
            }
            .download-btn:hover {
                background-color: #1565c0;
            }
            .folder-mode {
                background: #e3f2fd;
                border: 2px dashed #90caf9;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                border-radius: 8px;
                text-align: center;
            }
            .config-bar {
                margin: 1rem 0;
                padding: 0.5rem;
                background: #f5f5f5;
                border-radius: 4px;
                display: flex;
                gap: 1rem;
                align-items: center;
                justify-content: center;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Croissant</h1>
            <div
                id="status"
                style="
                    margin-bottom: 1rem;
                    color: #333;
                    font-weight: bold;
                    min-height: 1.5rem;
                    text-align: center;
                "
            ></div>
            <div style="text-align: right; margin-bottom: 0.5rem">
                <button
                    type="button"
                    id="showConfigBtn"
                    style="
                        background: none;
                        border: none;
                        color: #1976d2;
                        text-decoration: underline;
                        cursor: pointer;
                        font-size: 0.9rem;
                    "
                >
                    ðŸ“‚ Change Input Folder
                </button>
            </div>
            <div class="config-bar" style="display: none">
                <!-- Hidden config checkboxed -->
            </div>

            <!-- Removed Folder Mode UI, replaced with default scan info -->
            <div
                id="scan-info"
                style="
                    background: #e3f2fd;
                    border: 1px solid #90caf9;
                    padding: 1rem;
                    margin-bottom: 1.5rem;
                    border-radius: 4px;
                    text-align: center;
                    display: none;
                "
            ></div>

            <!-- Auto Scan Results Section -->
            <div
                id="autoScanResultContainer"
                class="result-container"
                style="
                    display: none;
                    margin-bottom: 2rem;
                    border-bottom: 2px dashed #ddd;
                    padding-bottom: 2rem;
                "
            >
                <h3 style="margin-top: 0; color: #1565c0">Auto-Scan Results</h3>
                <div
                    style="
                        display: flex;
                        gap: 10px;
                        justify-content: flex-end;
                        margin-bottom: 0.5rem;
                    "
                >
                    <button id="autoDownloadCopyBtn" class="download-btn">
                        Download & Copy Selected
                    </button>
                    <button
                        id="autoCopyDataOnlyBtn"
                        class="download-btn"
                        style="background-color: #2196f3"
                    >
                        Copy Table Data
                    </button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 30px">
                                <input
                                    type="checkbox"
                                    id="autoSelectAllCheck"
                                />
                            </th>
                            <th>Date Ordered</th>
                            <th>Order ID</th>
                            <th>Packing List</th>
                            <th>Picking List</th>
                            <th>Order From</th>
                            <th>From Whom</th>
                            <th>Status</th>
                            <th>Tracking Number</th>
                            <th>Created Time</th>
                        </tr>
                    </thead>
                    <tbody id="autoTableBody"></tbody>
                </table>
            </div>

            <div
                id="config-panel"
                style="
                    background: #fff3e0;
                    border: 1px solid #ffb74d;
                    padding: 1.5rem;
                    margin-bottom: 1.5rem;
                    border-radius: 4px;
                    display: none;
                    text-align: center;
                "
            >
                <h3 style="margin-top: 0; color: #f57c00">
                    Setup Process Folder
                </h3>
                <p>
                    Please enter the full folder path where your PDFs are
                    stored.
                </p>
                <div
                    style="
                        display: flex;
                        justify-content: center;
                        gap: 10px;
                        flex-wrap: wrap;
                    "
                >
                    <input
                        type="text"
                        id="configPathInput"
                        placeholder="C:\Users\Name\My Labels"
                        style="
                            flex: 1;
                            max-width: 400px;
                            padding: 0.5rem;
                            border: 1px solid #ccc;
                            border-radius: 4px;
                        "
                    />
                    <button
                        id="saveConfigBtn"
                        class="btn"
                        style="
                            width: auto;
                            padding: 0.5rem 1.5rem;
                            background-color: #f57c00;
                        "
                    >
                        Save Folder
                    </button>
                    <div class="spinner" id="configSpinner"></div>
                </div>
                <p
                    id="config-error"
                    style="
                        color: red;
                        font-size: 0.9rem;
                        margin-top: 5px;
                        display: none;
                    "
                ></p>
            </div>

            <form id="uploadForm">
                <div class="drop-zones">
                    <div class="drop-zone" id="mainDropZone">
                        <p style="font-size: 1.2rem; margin-bottom: 0.5rem">
                            <strong>Drag & Drop BOTH files here</strong>
                        </p>
                        <p
                            class="small"
                            style="
                                font-size: 0.8rem;
                                color: #888;
                                margin-top: 0;
                            "
                        >
                            Drop multiple pairs at once. <br />
                            Matching: Label filename â†” Order ID in slip
                        </p>
                        <input
                            type="file"
                            id="filesInput"
                            multiple
                            style="display: none"
                        />

                        <div
                            style="
                                margin-top: 1.5rem;
                                text-align: left;
                                background: #fafafa;
                                padding: 1rem;
                                border-radius: 4px;
                            "
                        >
                            <div id="files-preview" style="color: #666">
                                âšª No files selected
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    class="drop-zones"
                    style="border-top: 1px solid #eee; padding-top: 1rem"
                >
                    <div
                        class="drop-zone folder-mode"
                        id="bulkDropZone"
                        style="background: #f3e5f5; border-color: #ce93d8"
                    >
                        <p
                            style="
                                font-size: 1.2rem;
                                margin-bottom: 0.5rem;
                                color: #6a1b9a;
                            "
                        >
                            <strong>Bulk Processing</strong>
                        </p>
                        <p
                            class="small"
                            style="
                                font-size: 0.8rem;
                                color: #666;
                                margin-top: 0;
                            "
                        >
                            Drop 2 files: One with multiple Labels (2/page) and
                            one with multiple Slips.
                            <br />
                            Auto-matches by Order ID.
                        </p>
                        <input
                            type="file"
                            id="bulkFilesInput"
                            multiple
                            style="display: none"
                        />
                        <div
                            id="bulk-files-preview"
                            style="
                                margin-top: 1rem;
                                color: #666;
                                font-weight: bold;
                            "
                        >
                            âšª No bulk files selected
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1rem">
                    <button
                        type="button"
                        class="btn"
                        id="resetBtn"
                        style="background-color: #757575; flex: 1"
                    >
                        Reset
                    </button>
                    <button
                        type="submit"
                        class="btn"
                        id="submitBtn"
                        disabled
                        style="flex: 2"
                    >
                        <div class="spinner"></div>
                        Process All & Download
                    </button>
                </div>
            </form>

            <div
                id="manualResultContainer"
                class="result-container"
                style="display: none"
            >
                <h3 style="margin-top: 0; color: #f0541e">
                    Drag & Drop Results
                </h3>
                <div
                    style="
                        display: flex;
                        gap: 10px;
                        justify-content: flex-end;
                        margin-bottom: 0.5rem;
                    "
                >
                    <button id="manualDownloadCopyBtn" class="download-btn">
                        Download & Copy Selected
                    </button>
                    <button
                        id="manualCopyDataOnlyBtn"
                        class="download-btn"
                        style="background-color: #2196f3"
                    >
                        Copy Table Data
                    </button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 30px">
                                <input
                                    type="checkbox"
                                    id="manualSelectAllCheck"
                                />
                            </th>
                            <th>Date Ordered</th>
                            <th>Order ID</th>
                            <th>Packing List</th>
                            <th>Picking List</th>
                            <th>Order From</th>
                            <th>From Whom</th>
                            <th>Status</th>
                            <th>Tracking Number</th>
                            <th>Created Time</th>
                        </tr>
                    </thead>
                    <tbody id="manualTableBody"></tbody>
                </table>
            </div>

            <!-- Bulk Result Container -->
            <div
                id="bulkResultContainer"
                class="result-container"
                style="
                    display: none;
                    margin-top: 2rem;
                    border-top: 2px dashed #ddd;
                    padding-top: 2rem;
                "
            >
                <h3 style="margin-top: 0; color: #7b1fa2">
                    Bulk Processing Results
                </h3>
                <div
                    style="
                        display: flex;
                        gap: 10px;
                        justify-content: flex-end;
                        margin-bottom: 0.5rem;
                    "
                >
                    <button id="bulkDownloadCopyBtn" class="download-btn">
                        Download & Copy Selected
                    </button>
                    <button
                        id="bulkCopyDataOnlyBtn"
                        class="download-btn"
                        style="background-color: #2196f3"
                    >
                        Copy Table Data
                    </button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 30px">
                                <input
                                    type="checkbox"
                                    id="bulkSelectAllCheck"
                                />
                            </th>
                            <th>Date Ordered</th>
                            <th>Order ID</th>
                            <th>Packing List</th>
                            <th>Picking List</th>
                            <th>Order From</th>
                            <th>From Whom</th>
                            <th>Status</th>
                            <th>Tracking Number</th>
                            <th>Created Time</th>
                        </tr>
                    </thead>
                    <tbody id="bulkTableBody"></tbody>
                </table>
            </div>
        </div>

        <script>
            const dropZone = document.getElementById("mainDropZone");
            const fileInput = document.getElementById("filesInput");
            const statusDiv = document.getElementById("status");
            const submitBtn = document.getElementById("submitBtn");
            const resetBtn = document.getElementById("resetBtn");
            const filesPreview = document.getElementById("files-preview");
            const scanInfo = document.getElementById("scan-info");
            const configPanel = document.getElementById("config-panel");
            const configPathInput = document.getElementById("configPathInput");
            const saveConfigBtn = document.getElementById("saveConfigBtn");
            const showConfigBtn = document.getElementById("showConfigBtn");
            const configError = document.getElementById("config-error");

            // New Bulk Elements
            const bulkDropZone = document.getElementById("bulkDropZone");
            const bulkFilesInput = document.getElementById("bulkFilesInput");
            const bulkFilesPreview =
                document.getElementById("bulk-files-preview");

            // Replaced bulkModeCheck with separate drop zone logic
            // const bulkModeCheck = document.getElementById("bulkModeCheck");

            let selectedFiles = [];
            let selectedBulkFiles = []; // Storage for bulk files

            // Storage for results
            let autoScanResults = [];
            let manualScanResults = [];
            let bulkScanResults = [];

            // Auto Scan on Load
            document.addEventListener("DOMContentLoaded", () => {
                scanDefaultFolder();
                setupActionListeners("auto", () => autoScanResults);
                setupActionListeners("manual", () => manualScanResults);
                setupActionListeners("bulk", () => bulkScanResults);
            });

            // Reset Handler
            resetBtn.addEventListener("click", () => {
                // Clear selection
                selectedFiles = [];
                selectedBulkFiles = []; // Clear bulk

                // Clear inputs
                fileInput.value = "";
                bulkFilesInput.value = "";

                // Clear UI
                updatePreviews();
                updateBulkPreviews();

                dropZone.style.removeProperty("border-color");
                dropZone.style.removeProperty("background-color");

                // Return bulk zone to default inline styles
                bulkDropZone.style.backgroundColor = "#f3e5f5";
                bulkDropZone.style.borderColor = "#ce93d8";

                // Reset submit button state
                checkReady();

                // Clear Results Section
                document.getElementById("manualResultContainer").style.display =
                    "none";
                document.getElementById("manualTableBody").innerHTML = "";
                manualScanResults = [];
                document.getElementById("manualSelectAllCheck").checked = false;

                // Clear Bulk Results Section
                document.getElementById("bulkResultContainer").style.display =
                    "none";
                document.getElementById("bulkTableBody").innerHTML = "";
                bulkScanResults = [];
                document.getElementById("bulkSelectAllCheck").checked = false;

                // Clear status if it was about manual process
                if (
                    statusDiv.textContent.includes("(Manual)") ||
                    statusDiv.textContent.includes("(Bulk)")
                ) {
                    statusDiv.textContent = "";
                }
            });

            // Toggle Config Panel
            showConfigBtn.addEventListener("click", () => {
                const isHidden = configPanel.style.display === "none";
                configPanel.style.display = isHidden ? "block" : "none";
                if (isHidden) {
                    configPathInput.focus();
                }
            });

            // Config / Setup Logic
            saveConfigBtn.addEventListener("click", async () => {
                const newPath = configPathInput.value.trim();
                if (!newPath) {
                    showConfigError("Please enter a path.");
                    return;
                }

                showConfigError("");
                saveConfigBtn.disabled = true;
                saveConfigBtn.classList.add("loading");

                try {
                    const res = await fetch("/set-input-dir", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ path: newPath }),
                    });
                    const data = await res.json();

                    if (data.success) {
                        configPanel.style.display = "none";
                        // Re-trigger scan
                        scanDefaultFolder();
                    } else {
                        showConfigError(
                            data.error || "Failed to update configuration.",
                        );
                    }
                } catch (e) {
                    showConfigError("Network error.");
                } finally {
                    saveConfigBtn.disabled = false;
                    saveConfigBtn.classList.remove("loading");
                }
            });

            function showConfigError(msg) {
                if (msg) {
                    configError.textContent = msg;
                    configError.style.display = "block";
                } else {
                    configError.style.display = "none";
                }
            }

            async function scanDefaultFolder() {
                try {
                    statusDiv.textContent = "Scanning default input folder...";
                    const res = await fetch("/scan-default");
                    const data = await res.json();

                    if (data.configNeeded) {
                        statusDiv.textContent = "";
                        configPanel.style.display = "block";
                        return;
                    }

                    if (data.results && data.results.length > 0) {
                        statusDiv.textContent = `Auto-processed ${data.results.length} pairs from ${data.scannedDir || "folder"}.`;
                        statusDiv.style.color = "green";

                        autoScanResults = data.results;
                        renderResults(
                            autoScanResults,
                            "autoScanResultContainer",
                            "autoTableBody",
                            "auto",
                        );

                        scanInfo.style.display = "block";
                        scanInfo.innerHTML = `<strong>Auto-Scan Complete:</strong> Found ${data.results.length} pairs in <br><code>${data.scannedDir}</code> <br><span style="font-size:0.8rem">Check boxes to download/copy.</span>`;
                    } else {
                        statusDiv.textContent = `Scanned ${data.scannedDir || "default folder"}. No PDF pairs found.`;
                        statusDiv.style.color = "#666";
                        scanInfo.style.display = "block";
                        scanInfo.innerHTML = `<strong>Scan Complete:</strong> No PDF pairs found in <br><code>${data.scannedDir}</code>.`;

                        document.getElementById(
                            "autoScanResultContainer",
                        ).style.display = "none";

                        if (data.errors && data.errors.length > 0) {
                            console.log(data.errors);
                        }
                    }
                } catch (e) {
                    console.error("Auto scan failed", e);
                    statusDiv.textContent =
                        "Auto-scan failed (server offline?)";
                }
            }

            // Click to upload manually
            dropZone.addEventListener("click", () => fileInput.click());
            fileInput.addEventListener("change", (e) =>
                handleFiles(e.target.files),
            );

            // Drag & Drop events (Manual)
            dropZone.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZone.classList.add("dragover");
            });
            dropZone.addEventListener("dragleave", () =>
                dropZone.classList.remove("dragover"),
            );
            dropZone.addEventListener("drop", (e) => {
                e.preventDefault();
                dropZone.classList.remove("dragover");
                handleFiles(e.dataTransfer.files);
            });

            // BULK Drag & Drop Listeners
            bulkDropZone.addEventListener("click", () =>
                bulkFilesInput.click(),
            );
            bulkFilesInput.addEventListener("change", (e) =>
                handleBulkFiles(e.target.files),
            );

            bulkDropZone.addEventListener("dragover", (e) => {
                e.preventDefault();
                bulkDropZone.classList.add("dragover");
            });
            bulkDropZone.addEventListener("dragleave", () =>
                bulkDropZone.classList.remove("dragover"),
            );
            bulkDropZone.addEventListener("drop", (e) => {
                e.preventDefault();
                bulkDropZone.classList.remove("dragover");
                handleBulkFiles(e.dataTransfer.files);
            });

            function handleFiles(files) {
                if (!files || files.length === 0) return;
                selectedFiles = selectedFiles.concat(Array.from(files));
                updatePreviews();
                dropZone.style.borderColor = "#4CAF50";
                dropZone.style.backgroundColor = "#e8f5e9";
                checkReady();
            }

            function handleBulkFiles(files) {
                if (!files || files.length === 0) return;
                selectedBulkFiles = selectedBulkFiles.concat(Array.from(files));
                updateBulkPreviews();
                bulkDropZone.style.borderColor = "#7b1fa2";
                bulkDropZone.style.backgroundColor = "#e1bee7";
                checkReady();
            }

            function updatePreviews() {
                if (selectedFiles.length === 0) {
                    filesPreview.textContent = "âšª No files selected";
                    filesPreview.style.color = "#666";
                } else {
                    filesPreview.textContent = `âœ… ${selectedFiles.length} files selected (Ready to process)`;
                    filesPreview.style.color = "#2e7d32";
                    filesPreview.style.fontWeight = "bold";
                }
            }

            function updateBulkPreviews() {
                if (selectedBulkFiles.length === 0) {
                    bulkFilesPreview.textContent = "âšª No bulk files selected";
                    bulkFilesPreview.style.color = "#666";
                } else {
                    bulkFilesPreview.textContent = `âœ… ${selectedBulkFiles.length} bulk files selected`;
                    bulkFilesPreview.style.color = "#6a1b9a";
                    bulkFilesPreview.style.fontWeight = "bold";
                }
            }

            function checkReady() {
                const manualReady = selectedFiles.length > 0;
                const bulkReady = selectedBulkFiles.length > 0;

                if (manualReady || bulkReady) {
                    submitBtn.disabled = false;
                    if (bulkReady && manualReady) {
                        statusDiv.textContent = `${selectedFiles.length} manual files & ${selectedBulkFiles.length} bulk files ready.`;
                    } else if (bulkReady) {
                        statusDiv.textContent = `${selectedBulkFiles.length} bulk files ready to process.`;
                    } else {
                        statusDiv.textContent = `${selectedFiles.length} files ready to process.`;
                    }
                    statusDiv.style.color = "#333";
                } else {
                    submitBtn.disabled = true;
                    statusDiv.textContent = "Please select files...";
                    statusDiv.style.color = "#666";
                }
            }

            // Helper to Setup Listeners dynamically
            function setupActionListeners(prefix, getResultsFn) {
                const selectAll = document.getElementById(
                    `${prefix}SelectAllCheck`,
                );
                const downloadBtn = document.getElementById(
                    `${prefix}DownloadCopyBtn`,
                );
                const copyDataBtn = document.getElementById(
                    `${prefix}CopyDataOnlyBtn`,
                );
                const tbody = document.getElementById(`${prefix}TableBody`);

                if (!selectAll || !downloadBtn) return;

                selectAll.addEventListener("change", (e) => {
                    const isChecked = e.target.checked;
                    // Scoped query selector for this table body only
                    const checkboxes = tbody.querySelectorAll(".row-checkbox");
                    checkboxes.forEach((cb) => (cb.checked = isChecked));
                });

                // Helper to copy rows
                const handleCopy = (checkboxes) => {
                    const rows = [];
                    checkboxes.forEach((cb) => {
                        const row = cb.closest("tr");
                        // Skip first cell (checkbox)
                        const rowText = Array.from(row.cells)
                            .slice(1)
                            .map((c) => c.textContent)
                            .join("\t");
                        rows.push(rowText);
                    });

                    if (rows.length > 0) {
                        copyToClipboard(rows.join("\n"));
                    }
                };

                downloadBtn.addEventListener("click", () => {
                    const checkboxes = tbody.querySelectorAll(
                        ".row-checkbox:checked",
                    );
                    if (checkboxes.length === 0) {
                        alert("Please select items to download & copy.");
                        return;
                    }

                    const results = getResultsFn();

                    // 1. Download
                    checkboxes.forEach((cb) => {
                        const resultIndex = parseInt(cb.dataset.index);
                        if (!isNaN(resultIndex) && results[resultIndex]) {
                            const result = results[resultIndex];
                            downloadPdf(result.pdfBase64, result.filename);
                        }
                    });

                    // 2. Copy
                    handleCopy(checkboxes);
                });

                // New Copy Data Only Button
                if (copyDataBtn) {
                    copyDataBtn.addEventListener("click", () => {
                        const checkboxes = tbody.querySelectorAll(
                            ".row-checkbox:checked",
                        );
                        if (checkboxes.length === 0) {
                            alert("Please select items to copy.");
                            return;
                        }
                        handleCopy(checkboxes);
                    });
                }
            }

            async function processFiles() {
                // Determine Mode
                let isBulk = false;
                let filesToProcess = [];

                if (selectedBulkFiles.length > 0) {
                    isBulk = true;
                    filesToProcess = selectedBulkFiles;
                } else if (selectedFiles.length > 0) {
                    isBulk = false;
                    filesToProcess = selectedFiles;
                } else {
                    return;
                }

                // Update UI to loading state
                submitBtn.classList.add("loading");
                submitBtn.disabled = true;
                statusDiv.textContent = "Processing...";
                statusDiv.style.color = "#f0541e";

                // Reset Manual Container
                document.getElementById("manualResultContainer").style.display =
                    "none";
                document.getElementById("manualTableBody").innerHTML = "";
                manualScanResults = [];
                document.getElementById("manualSelectAllCheck").checked = false;

                // Reset Bulk Container
                document.getElementById("bulkResultContainer").style.display =
                    "none";
                document.getElementById("bulkTableBody").innerHTML = "";
                bulkScanResults = [];
                document.getElementById("bulkSelectAllCheck").checked = false;

                const formData = new FormData();
                filesToProcess.forEach((file) => {
                    formData.append("files", file);
                });
                formData.append("isBulk", isBulk);

                try {
                    const response = await fetch("/merge", {
                        method: "POST",
                        body: formData,
                    });

                    if (response.ok) {
                        const data = await response.json();

                        if (data.results && data.results.length > 0) {
                            const modeStr = isBulk ? "Bulk" : "Manual";
                            statusDiv.textContent = `Success! Processed ${data.results.length} pairs (${modeStr}).`;
                            statusDiv.style.color = "green";

                            if (isBulk) {
                                bulkScanResults = data.results;
                                renderResults(
                                    bulkScanResults,
                                    "bulkResultContainer",
                                    "bulkTableBody",
                                    "bulk",
                                );

                                // Auto-select all for Bulk
                                document.getElementById(
                                    "bulkSelectAllCheck",
                                ).checked = true;
                                document
                                    .getElementById("bulkTableBody")
                                    .querySelectorAll(".row-checkbox")
                                    .forEach((cb) => (cb.checked = true));
                            } else {
                                manualScanResults = data.results;
                                renderResults(
                                    manualScanResults,
                                    "manualResultContainer",
                                    "manualTableBody",
                                    "manual",
                                );

                                // Auto-select all for Drag & Drop
                                document.getElementById(
                                    "manualSelectAllCheck",
                                ).checked = true;
                                document
                                    .getElementById("manualTableBody")
                                    .querySelectorAll(".row-checkbox")
                                    .forEach((cb) => (cb.checked = true));
                            }

                            if (data.errors && data.errors.length > 0) {
                                statusDiv.textContent += ` (${data.errors.length} errors)`;
                                console.warn(data.errors);
                            }

                            // AUTO DOWNLOAD/COPY FOR MANUAL FLOW (Restored behavior)
                            data.results.forEach((result) => {
                                downloadPdf(result.pdfBase64, result.filename);
                            });

                            // Copy all rows
                            const targetBodyId = isBulk
                                ? "bulkTableBody"
                                : "manualTableBody";
                            const allRowsCopy = [];
                            document
                                .querySelectorAll(`#${targetBodyId} tr`)
                                .forEach((tr) => {
                                    allRowsCopy.push(
                                        Array.from(tr.cells)
                                            .slice(1)
                                            .map((c) => c.textContent)
                                            .join("\t"),
                                    );
                                });
                            copyToClipboard(allRowsCopy.join("\n"));

                            // Clear files after successful processing
                            if (isBulk) {
                                selectedBulkFiles = [];
                                bulkFilesInput.value = "";
                                updateBulkPreviews();
                                bulkDropZone.style.removeProperty(
                                    "border-color",
                                );
                                bulkDropZone.style.backgroundColor = "#f3e5f5";
                                bulkDropZone.style.borderColor = "#ce93d8";
                            } else {
                                selectedFiles = [];
                                fileInput.value = "";
                                updatePreviews();
                                dropZone.style.removeProperty("border-color");
                                dropZone.style.removeProperty(
                                    "background-color",
                                );
                            }
                            checkReady();
                        } else {
                            statusDiv.textContent =
                                "No valid pairs found to process.";
                            if (data.errors && data.errors.length > 0) {
                                alert("Errors:\n" + data.errors.join("\n"));
                            } else {
                                alert(
                                    "No pairs found. Ensure matching file names (Order ID in filename).",
                                );
                            }

                            // Reset on Error too
                            if (isBulk) {
                                selectedBulkFiles = [];
                                bulkFilesInput.value = "";
                                updateBulkPreviews();
                                bulkDropZone.style.removeProperty(
                                    "border-color",
                                );
                                bulkDropZone.style.backgroundColor = "#f3e5f5";
                                bulkDropZone.style.borderColor = "#ce93d8";
                            } else {
                                selectedFiles = [];
                                fileInput.value = "";
                                updatePreviews();
                                dropZone.style.removeProperty("border-color");
                                dropZone.style.removeProperty(
                                    "background-color",
                                );
                            }
                            checkReady();
                        }
                    } else {
                        const errorText = await response.text();
                        statusDiv.textContent = "Error: " + errorText;
                        statusDiv.style.color = "red";
                        alert("Error:\n" + errorText);

                        // Reset on Server Error
                        if (isBulk) {
                            selectedBulkFiles = [];
                            bulkFilesInput.value = "";
                            updateBulkPreviews();
                            bulkDropZone.style.removeProperty("border-color");
                            bulkDropZone.style.backgroundColor = "#f3e5f5";
                            bulkDropZone.style.borderColor = "#ce93d8";
                        } else {
                            selectedFiles = [];
                            fileInput.value = "";
                            updatePreviews();
                            dropZone.style.removeProperty("border-color");
                            dropZone.style.removeProperty("background-color");
                        }
                        checkReady();
                    }
                } catch (err) {
                    console.error(err);
                    statusDiv.textContent = "Network Error";
                    statusDiv.style.color = "red";

                    // Reset on Network Error
                    if (typeof isBulk !== "undefined" && isBulk) {
                        selectedBulkFiles = [];
                        bulkFilesInput.value = "";
                        updateBulkPreviews();
                        bulkDropZone.style.removeProperty("border-color");
                        bulkDropZone.style.backgroundColor = "#f3e5f5";
                        bulkDropZone.style.borderColor = "#ce93d8";
                    } else {
                        selectedFiles = [];
                        fileInput.value = "";
                        updatePreviews();
                        dropZone.style.removeProperty("border-color");
                        dropZone.style.removeProperty("background-color");
                    }
                    checkReady();
                } finally {
                    submitBtn.classList.remove("loading");
                    submitBtn.disabled = false;
                }
            }

            function renderResults(results, containerId, tbodyId, type) {
                document.getElementById(containerId).style.display = "block";
                const tbody = document.getElementById(tbodyId);
                tbody.innerHTML = "";

                results.forEach((result, index) => {
                    const rowData = addTableRow(
                        result.metadata,
                        index,
                        tbody,
                        type,
                    );
                });
            }

            function downloadPdf(base64Data, filename) {
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], {
                    type: "application/octet-stream",
                });

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            }

            function addTableRow(meta, index, tbody, type) {
                const date = meta.date || "-";
                const orderId = meta.orderId || "-";
                const packingList = "-";
                const pickingList = "-";
                const orderFrom =
                    meta.type === "etsy"
                        ? "Etsy"
                        : meta.type === "tiktok"
                          ? "TikTok"
                          : "-";
                const fromWhom = "Real Order";
                const status = "Awaiting collection";
                const tracking = meta.tracking || "-";
                const createdTime = date;

                const rowValues = [
                    date,
                    orderId,
                    packingList,
                    pickingList,
                    orderFrom,
                    fromWhom,
                    status,
                    tracking,
                    createdTime,
                ];

                const tr = document.createElement("tr");

                // Checkbox column
                const tdCheck = document.createElement("td");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.className = "row-checkbox";
                checkbox.dataset.index = index;
                checkbox.dataset.type = type; // 'auto' or 'manual'
                tdCheck.appendChild(checkbox);
                tr.appendChild(tdCheck);

                // Row click toggles checkbox
                tr.addEventListener("click", (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                });

                rowValues.forEach((val) => {
                    const td = document.createElement("td");
                    td.textContent = val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);

                return rowValues.join("\t");
            }

            function copyToClipboard(text) {
                navigator.clipboard
                    .writeText(text)
                    .then(() => {
                        const originalText = statusDiv.textContent;
                        statusDiv.textContent += " (Copied to clipboard!)";
                        setTimeout(() => {
                            if (
                                statusDiv.textContent.includes(
                                    "(Copied to clipboard!)",
                                )
                            ) {
                                statusDiv.textContent =
                                    statusDiv.textContent.replace(
                                        " (Copied to clipboard!)",
                                        "",
                                    );
                            }
                        }, 3000);
                    })
                    .catch((err) => {
                        console.error("Failed to copy: ", err);
                    });
            }

            const form = document.getElementById("uploadForm");
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                processFiles();
            });
        </script>
    </body>
</html>
